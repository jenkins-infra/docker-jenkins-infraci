---
name: Bump Jenkins Plugin versions

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      owner: "{{ .github.owner }}"
      repository: "{{ .github.repository }}"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ .github.username }}"
      branch: "{{ .github.branch }}"

sources:
  getCurrentDockerTagSuffix:
    name: Get current Jenkins base image
    kind: file
    spec:
      file: ./Dockerfile
    transformers:
      - findsubmatch:
          pattern: "FROM jenkins/jenkins:(.*)-(.*)"
          captureindex: 2
  getLatestJenkinsVersion:
    kind: jenkins
    name: Get the latest weekly Jenkins version
    spec:
      release: weekly
    transformers:
      - addsuffix: '-{{ source "getCurrentDockerTagSuffix" }}'
  getLatestPlugins:
    name: Update Jenkins plugins
    kind: shell
    spec:
      # Note the ' && echo' to ensure output ends with an empty newline (POSIX)
      command: |
        docker container run --rm --volume=$(pwd):/data:ro --entrypoint=bash jenkins/jenkins:{{ source "getLatestJenkinsVersion" }} \
          -c 'jenkins-plugin-cli --plugin-file /data/plugins.txt --available-updates --output txt && echo'

conditions:
  testDockerImageExists:
    name: Does the Docker Image exist on the Docker Hub?
    kind: dockerimage
    sourceid: getLatestJenkinsVersion
    spec:
      image: jenkins/jenkins
      architectures:
        - amd64
        - arm64

targets:
  updateDockerfile:
    name: Update the Dockerfile with the new version
    kind: dockerfile
    sourceid: getLatestJenkinsVersion
    spec:
      file: Dockerfile
      instruction:
        keyword: FROM
        matcher: jenkins/jenkins
    scmid: default
  updatePlugins:
    name: Update Jenkins plugins
    sourceid: getLatestPlugins
    kind: file
    spec:
      file: ./plugins.txt
    scmid: default

actions:
  default:
    kind: github/pullrequest
    scmid: default
    title: Bump Jenkins core and/or plugin versions
    spec:
      labels:
        - dependencies
        - jenkins-plugins
